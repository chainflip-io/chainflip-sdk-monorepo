name: Node JS Publish NPM Package Reusable Workflow

on:
  workflow_call:
    inputs:
      runs_on:
        description: Runs on
        required: false
        type: string
        default: ubuntu-latest
      node_version:
        description: Node version
        required: false
        type: string
        default: 18.x
      package_registry:
        description: Package registry
        required: false
        type: string
        default: https://npm.pkg.github.com
      package_scope:
        description: Package scope
        required: false
        type: string
        default: '@chainflip-io'
      build_cmd:
        description: Build command
        required: false
        type: string
        default: pnpm run build
      publish_cmd:
        description: Publish command
        required: false
        type: string
        default: pnpm publish
      git_tag:
        description: Git Tag
        required: true
        type: string
    secrets:
      node_auth_token:
        description: Node auth token
        required: true
      ssh_private_key:
        description: SSH private key
        required: true

permissions:
  packages: write
  contents: read

jobs:
  publish:
    runs-on: ${{ inputs.runs_on }}
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Install pnpm ðŸ’¿
        run: npm i -g pnpm@10

      - name: Setup Node.js ${{ inputs.node_version }} ðŸŽ®
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'pnpm'
          registry-url: ${{ inputs.package_registry }}
          scope: ${{ inputs.package_scope }}

      - name: Install dependencies ðŸ“¦
        run: |
          for i in {1..5}
          do
            pnpm install && break
            sleep 10
          done

      - name: Build ðŸ—ï¸
        run: ${{ inputs.build_cmd }}

      - name: Publish npm package ðŸ“¦
        env:
          NODE_AUTH_TOKEN: ${{ secrets.node_auth_token }}
        run: ${{ inputs.publish_cmd }}

      - name: Import SSH key ðŸ”‘
        uses: webfactory/ssh-agent@v0.9.0
        with:
            ssh-private-key: ${{ inputs.ssh_private_key }}
      - name: Config Git ðŸ› 
        shell: bash
        run: |
          echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINiFBr1ixKLrG8EbWyeBiZaE7IB6PSODpUJH624v8kKw" >> /tmp/signingkey.pub
          git config --global user.email "dev@chainflip.io"
          git config --global user.name "Flippy"
          git config --global commit.gpgsign true
          git config --global gpg.format ssh
          git config --global user.signingkey /tmp/signingkey.pub


      - name: Create Git Tag ðŸ”–
        run: |
          git tag ${{ inputs.git_tag }}
          git push --tags
