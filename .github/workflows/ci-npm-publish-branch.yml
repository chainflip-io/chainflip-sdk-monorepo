name: NPM Publish Branch Workflow

on:
  workflow_dispatch:
    inputs:
      npm_tag:
        description: 'NPM dist-tag (e.g., alpha, beta, dev). Cannot be "latest".'
        required: true
        type: string
      package:
        description: 'Package to publish'
        required: true
        type: choice
        options:
          - sdk
          - cli

permissions:
  packages: write
  contents: write

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Validate branch is not main
        if: github.ref_name == 'main'
        run: |
          echo "::error::Cannot publish from main branch. Use the standard ci-npm-publish workflow instead."
          exit 1

      - name: Validate npm tag is not latest
        if: inputs.npm_tag == 'latest'
        run: |
          echo "::error::Cannot use 'latest' npm tag for branch publishes. Use a prerelease tag (e.g., alpha, beta, dev)."
          exit 1

  validate-version:
    needs: [validate-inputs]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Get package version
        id: get-version
        run: |
          VERSION=$(jq -r .version ./packages/${{ inputs.package }}/package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Validate version has prerelease suffix
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          # Pattern: X.Y.Z-suffix.N (e.g., 1.0.0-alpha.0, 2.1.3-beta.1)
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-.+\.[0-9]+$ ]]; then
            echo "::error::Package version '$VERSION' must have a prerelease suffix (e.g., 1.0.0-alpha.0, 1.0.0-beta.1)"
            exit 1
          fi
          echo "Version '$VERSION' has valid prerelease suffix"

  get-node-version:
    needs: [validate-version]
    uses: ./.github/workflows/_node_context.yml

  pre-checks:
    needs: [validate-version]
    uses: ./.github/workflows/_01_pre_checks.yml
    with:
      package: ${{ inputs.package }}
    secrets: inherit

  checks:
    needs: [pre-checks]
    uses: ./.github/workflows/_02_checks.yml
    with:
      package: ${{ inputs.package }}
    secrets: inherit

  publish:
    needs: [get-node-version, validate-version, checks]
    uses: ./.github/workflows/_npm_publish.yml
    with:
      node_version: ${{ needs.get-node-version.outputs.node_version }}
      package_registry: 'https://registry.npmjs.org'
      package_scope: '@chainflip-io'
      build_cmd: pnpm --filter @chainflip/${{ inputs.package }} build
      publish_cmd: pnpm --filter @chainflip/${{ inputs.package }} publish --tag ${{ inputs.npm_tag }} --no-git-checks
      git_tag: '@chainflip/${{ inputs.package }}/v${{ needs.validate-version.outputs.version }}'
    secrets:
      node_auth_token: ${{ secrets.CF_NPM_JS_PACKAGES_READ_WRITE }}
      ssh_private_key: ${{ secrets.CF_GITHUB_BOT_SSH_PRIVATE_KEY }}
